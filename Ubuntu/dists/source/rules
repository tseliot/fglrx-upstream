#!/usr/bin/make -f
# Copyright (C) 2002-2005 Flavio Stanchina
# Copyright (C) 2005-2006 Aric Cyr
# Copyright (C) 2007-2008 Mario Limonciello

include /usr/share/cdbs/1/rules/debhelper.mk

# Figure out some magic versioning
CVERSION := $(shell dpkg-parsechangelog | grep '^Version:' | cut -d' ' -f2 | cut -d- -f1 | cut -d\: -f2)
DVERSION := $(shell dpkg-parsechangelog | grep '^Version:' | cut -d' ' -f2 | cut -d\: -f2)
DISTRO   := $(shell dpkg-parsechangelog | grep '^Distribution:' | cut -d' ' -f2 | cut -d\: -f2)

#Directory naming schemes
DRIDIR   := usr/lib
DRIDIR32 := usr/lib32
XMODDIR  := $(DRIDIR)/xorg/modules
LIBDIR   := lib
ARCH     := x86
XARCH    := x740

ifeq ($(DEB_BUILD_ARCH),amd64)
	LIBDIR  := lib64
	ARCH    := x86_64
	XARCH   := $(XARCH)_64a
endif

# Package names
PKG_driver      := fglrx
PKG_driver_dev  := fglrx-dev
PKG_control     := fglrx-amdcccle


# Unfortunately, we won't have libstdc++5 at build time
# Also, we can't go and use debian/shlibs.local.  It requires
# that you have the library installed, and that library
# just forgot to ship a shlibs file.
# See (LP: #271794) for more information
DEB_DH_SHLIBDEPS_ARGS_ALL="-Xlib32"
DEB_DH_SHLIBDEPS_ARGS_$(PKG_UVD_library)="-XlibAMD"

configure/$(PKG_driver)::

	#Create important strings
	for i in 10fglrx \
			 dkms.conf \
			 $(PKG_driver).install \
			 $(PKG_driver_dev).install \
			 $(PKG_control).install \
			 overrides/$(PKG_driver); do \
		sed -e "s|#XMODDIR#|$(XMODDIR)|"     \
			-e "s|#XMODDIR32#|$(XMODDIR32)|" \
			-e "s|#DRIDIR32#|$(DRIDIR32)|"   \
			-e "s|#LIBDIR#|$(LIBDIR)|"       \
			-e "s|#DRIDIR#|$(DRIDIR)|"       \
			-e "s|#CVERSION#|$(CVERSION)|"   \
			-e "s|#XARCH#|$(XARCH)|"   \
			-e "s|#ARCH#|$(ARCH)|"   \
			debian/$$i.in > debian/$$i;      \
	done

	# remove exec bit on everything
	find arch \
		etc \
		lib \
		module \
		usr \
		$(XARCH)     -type f | xargs chmod -x

	# set executable on user apps
	find arch/$(ARCH)/usr/sbin \
		arch/$(ARCH)/usr/X11R6/bin \
		usr/sbin/ -type f | xargs chmod a+x

	# set exec bit on scripts
	find lib etc debian -name "*.sh" -type f | xargs chmod +x

	# Generate modaliases
	sh -e debian/modaliases/fglrx_supported \
		$(XARCH)/usr/X11R6/$(LIBDIR)/modules/drivers/fglrx_drv.so > \
		debian/modaliases/fglrx-modules.alias.override

clean::
	rm -f debian/{10fglrx, \
		dkms.conf, \
		$(PKG_driver).install, \
		$(PKG_driver_dev).install, \
		$(PKG_control).install, \
		overrides/$(PKG_driver), \
		modaliases/fglrx-modules.alias.override}

binary-install/$(PKG_driver)::
ifeq ($(DEB_BUILD_ARCH),amd64)
	#driver package
	dh_install -p$(PKG_UVD_library) "arch/x86/usr/X11R6/lib/libAMD*.so*"           "usr/lib32"
	dh_install -XlibAMD -p$(PKG_driver) "arch/x86/usr/X11R6/lib/*.so*"           "usr/lib32"
	dh_install -p$(PKG_driver) "arch/x86/usr/X11R6/lib/modules/dri"     "$(DRIDIR32)"
	dh_install -p$(PKG_driver) "arch/x86/usr/lib/*"                     "usr/lib32"
	dh_installdirs -p$(PKG_driver) "usr/lib32/fglrx"

	for i in \
			debian/$(PKG_driver)/$(DRIDIR32)/dri/fglrx_dri.so \
			debian/$(PKG_driver)/usr/lib32/libGL.so.* \
			; do execstack -q $$i; execstack -c $$i; done

	#they don't provide the symlink for us (starting at 8.699)
	dh_link -p$(PKG_driver) usr/lib32/libatiuki.so.1.0 usr/lib32/libatiuki.so.1
endif
	#they don't provide the symlink for us (starting at 8.699)
	dh_link -p$(PKG_driver) usr/lib/libatiuki.so.1.0 usr/lib/libatiuki.so.1

	dh_installdocs -p$(PKG_driver) usr/share/doc/fglrx/* --exclude ATI_LICENSE.TXT
	dh_installinit -p$(PKG_driver) --name="atieventsd" --no-start --update-rcd-params="defaults 31"

	for i in \
			debian/$(PKG_driver)/usr/bin/atiode \
			debian/$(PKG_driver)/usr/sbin/amdnotifyui \
			debian/$(PKG_driver)/usr/lib/dri/fglrx_dri.so \
			debian/$(PKG_driver)/usr/lib/libGL.so.* \
			; do execstack -q $$i; execstack -c $$i; done

binary-install/$(PKG_control)::
	execstack -c debian/$(PKG_control)/usr/bin/amdcccle
